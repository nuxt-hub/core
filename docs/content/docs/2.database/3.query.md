---
title: Database Queries
description: Read and write data using Drizzle ORM in Nuxt, including relational queries, filtering, joining, and aggregating data with full type-safety.
navigation.title: Queries
---

Now that you have your database schema, relations, and migrations set up, you can start querying your database.

## Importing the database

NuxtHub provides two ways to import the database client:

### Recommended: `@nuxthub/db`

Use `@nuxthub/db` to import the database client. This works everywhere, including in Nuxt server routes and external bundlers like [Workflow](https://useworkflow.dev):

```ts
import { db, schema } from '@nuxthub/db'
```

::tip{icon="i-lucide-sparkles"}
This is the **recommended approach** as it works with both Nuxt and external tools that bundle your code independently.
::

### Legacy: `hub:db`

The virtual module `hub:db` is still supported for backwards compatibility (Nuxt only):

```ts
import { db, schema } from 'hub:db'
```

::tip
`db` and `schema` are auto-imported on the server-side, so you can use them directly without importing.
::

## Relational queries

Use `db.query` to fetch data with relations using the Drizzle ORM Relations v2 query API. Filter and sort results with object-based `where` and `orderBy`:

```ts [server/api/posts.get.ts]
import { db } from '@nuxthub/db'

export default eventHandler(async () => {
  // Get all posts with their author
  return await db.query.posts.findMany({
    with: {
      author: true
    }
  })
})
```

### Filter with `where`

Pass an object to `where` to filter results. Properties map directly to column names:

```ts [server/api/users/[id]/posts.get.ts]
import { db } from '@nuxthub/db'

export default eventHandler(async (event) => {
  const { id } = getRouterParams(event)

  return await db.query.posts.findMany({
    where: {
      authorId: Number(id)
    },
    orderBy: {
      createdAt: 'desc'
    }
  })
})
```

Use operators for advanced filtering:

```ts
// Posts created in the last 7 days
const recentPosts = await db.query.posts.findMany({
  where: {
    createdAt: { gt: new Date(Date.now() - 7 * 24 * 60 * 60 * 1000) }
  }
})

// Users matching multiple conditions
const users = await db.query.users.findMany({
  where: {
    OR: [
      { name: { like: 'John%' } },
      { email: { like: '%@example.com' } }
    ]
  }
})
```

### Include relations with `with`

Nest `with` to load deeply related data in a single query:

```ts [server/api/posts/[id].get.ts]
import { db } from '@nuxthub/db'

export default eventHandler(async (event) => {
  const { id } = getRouterParams(event)

  return await db.query.posts.findFirst({
    where: { id: Number(id) },
    with: {
      author: true,
      comments: {
        with: {
          author: true
        },
        orderBy: {
          createdAt: 'desc'
        },
        limit: 20
      }
    }
  })
})
```

### Partial field selection

Use `columns` to include or exclude specific fields from the response:

```ts
const posts = await db.query.posts.findMany({
  columns: {
    id: true,
    title: true,
  },
  with: {
    author: {
      columns: {
        name: true
      }
    }
  }
})
```

::callout{to="https://orm.drizzle.team/docs/rqb-v2" external}
Learn more about [Drizzle relational queries v2](https://orm.drizzle.team/docs/rqb-v2) on the Drizzle documentation.
::

## SQL Select

```ts [server/api/users.get.ts]
import { db, schema } from '@nuxthub/db'

export default eventHandler(async (event) => {
  return await db.query.users.findMany()
  // or
  return await db.select().from(schema.users)
})
```

::callout{to="https://orm.drizzle.team/docs/select" external}
Learn more about [Drizzle ORM select](https://orm.drizzle.team/docs/select) on the Drizzle documentation.
::

## SQL Insert

```ts [server/api/users.post.ts]
import { db, schema } from '@nuxthub/db'

export default eventHandler(async (event) => {
  const { name, email } = await readBody(event)

  return await db
    .insert(schema.users)
    .values({
      name,
      email,
      createdAt: new Date()
    })
    .returning()
})
```

::callout{to="https://orm.drizzle.team/docs/insert" external}
Learn more about [Drizzle ORM insert](https://orm.drizzle.team/docs/insert) on the Drizzle documentation.
::

## SQL Update

```ts [server/api/users/[id\\].patch.ts]
import { db, schema } from '@nuxthub/db'

export default eventHandler(async (event) => {
  const { id } = getRouterParams(event)
  const { name } = await readBody(event)

  return await db
    .update(schema.users)
    .set({ name })
    .where(eq(tables.users.id, Number(id)))
    .returning()
})
```

::callout{to="https://orm.drizzle.team/docs/update" external}
Learn more about [Drizzle ORM update](https://orm.drizzle.team/docs/update) on the Drizzle documentation.
::

## SQL Delete

```ts [server/api/users/[id\\].delete.ts]
import { db, schema } from '@nuxthub/db'

export default eventHandler(async (event) => {
  const { id } = getRouterParams(event)

  const deletedUser = await db
    .delete(schema.users)
    .where(eq(schema.users.id, Number(id)))
    .returning()

  if (!deletedUser) {
    throw createError({
      statusCode: 404,
      message: 'User not found'
    })
  }

  return { deleted: true }
})
```

::callout{to="https://orm.drizzle.team/docs/delete" external}
Learn more about [Drizzle ORM delete](https://orm.drizzle.team/docs/delete) on the Drizzle documentation.
::

## Using with external bundlers

The `@nuxthub/db` import works seamlessly with external tools that bundle your code independently, such as [Workflow](https://useworkflow.dev).

### Example with Workflow

[Workflow](https://useworkflow.dev) is a library for building and running durable, reliable, and scalable background jobs in TypeScript. Here's how to use NuxtHub Database with Workflow:

```ts [workflow/tasks/cleanup-inactive-users.ts]
import { db, schema } from '@nuxthub/db'
import { lt } from 'drizzle-orm'

export default async function cleanupInactiveUsers() {
  // Delete users who haven't logged in for 90 days
  const ninetyDaysAgo = new Date(Date.now() - 90 * 24 * 60 * 60 * 1000)

  const deleted = await db
    .delete(schema.users)
    .where(lt(schema.users.lastLoginAt, ninetyDaysAgo))
    .returning()

  return {
    deletedCount: deleted.length,
    deletedUserIds: deleted.map(u => u.id)
  }
}
```

### How it works

When you build your Nuxt application:

1. NuxtHub generates the database client at `node_modules/@nuxthub/db/`
2. This physical module contains your compiled database schema and client
3. External bundlers like Workflow can import and bundle this module directly
4. The `hub:db` virtual module remains available for Nuxt server routes (backwards compatibility)

::tip{icon="i-lucide-info"}
The `@nuxthub/db` package is auto-generated during development and build. You don't need to add it to your `package.json`.
::

### Benefits

- **Universal compatibility**: Works with Nuxt server routes, Workflow tasks, and any other TypeScript code
- **Type-safe**: Full TypeScript support with auto-generated types
- **No configuration**: Automatically synced when you run `nuxt dev` or `nuxt build`
- **Single source of truth**: Your `server/db/schema.ts` files are the only place you define your schema
