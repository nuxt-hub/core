---
title: Database Migrations
description: Manage database schema changes in Nuxt with Drizzle ORM migrations, including creating, applying, and tracking migration files safely.
navigation.title: Migrations
---

Database migrations provide version control for your database schema. NuxtHub supports SQL migration files (`.sql`) and automatically applies them during development and deployment. Making them fully compatible with Drizzle Kit generated migrations.

::note
Create dialect-specific migrations with `.<dialect>.sql` suffix (e.g., `0001_create-todos.postgresql.sql`).
::

### Migrations Directories

NuxtHub scans `server/db/migrations` for migrations in each [Nuxt layer](https://nuxt.com/docs/getting-started/layers).

To scan additional directories, specify them in your config:

```ts [nuxt.config.ts]
export default defineNuxtConfig({
  hub: {
    db: {
      dialect: 'postgresql',
      migrationsDirs: [
        'server/db/custom-migrations/'
      ]
    }
  }
})
```

For more control (e.g., in Nuxt modules), use the `hub:db:migrations:dirs` hook:

::code-group
```ts [modules/auth/index.ts]
import { createResolver, defineNuxtModule } from '@nuxt/kit'

export default defineNuxtModule({
  meta: {
    name: 'my-auth-module'
  },
  setup(options, nuxt) {
    const { resolve } = createResolver(import.meta.url)

    nuxt.hook('hub:db:migrations:dirs', (dirs) => {
      dirs.push(resolve('./db-migrations'))
    })
  }
})
```
```sql [modules/auth/db-migrations/0001_create-users.sql]
CREATE TABLE IF NOT EXISTS users (
  id INTEGER PRIMARY KEY,
  name TEXT NOT NULL,
  email TEXT NOT NULL
);
```
::

::tip
All migration files are copied to `.data/db/migrations` when you run Nuxt, giving you a consolidated view.
::

## Automatic migrations

Migrations are automatically applied when you:
- Start the development server (`npx nuxt dev`)
- Build the application (`npx nuxt build`)

Applied migrations are tracked in the `_hub_migrations` database table.

::warning{to="/docs/getting-started/deploy#cloudflare"}
For Cloudflare D1, migrations cannot run during build since there is no database connection in CI. Run `npx nuxt db migrate` locally or set up a CI step to apply migrations before deployment.
::

::note
To disable automatic migrations during `nuxt build`, you can set the `applyMigrationsDuringBuild` option to `false`:

```ts [nuxt.config.ts]
export default defineNuxtConfig({
  hub: {
    db: {
      applyMigrationsDuringBuild: false
    }
  }
})
```
::

## Generating migrations

Once you have updates your database schema, you can generate new migrations using the following command:

```bash [Terminal]
npx nuxt db generate
```

This will generate new migrations files in `server/db/migrations/{dialect}/` which are automatically applied during development and deployment.

## Applying migrations

Once you have generated new migrations, you can apply them using the following command:

```bash [Terminal]
npx nuxt db migrate
```

This will apply the new migrations to your database.

::tip
When running the development server, NuxtHub will automatically apply the migrations for you.
::

## Post-migration queries

::important
Advanced use case: These queries run after migrations but aren't tracked in `_hub_migrations`. Ensure they're idempotent.
::

Use the `hub:db:queries:paths` hook to run additional queries after migrations:

::code-group
```ts [modules/admin/index.ts]
import { createResolver, defineNuxtModule } from '@nuxt/kit'

export default defineNuxtModule({
  meta: {
    name: 'my-auth-module'
  },
  setup(options, nuxt) {
    const { resolve } = createResolver(import.meta.url)

    nuxt.hook('hub:db:queries:paths', (paths, dialect) => {
      paths.push(resolve(`./db-queries/seed-admin.${dialect}.sql`))
    })
  }
})
```
```sql [modules/admin/db-queries/seed-admin.sql]
INSERT OR IGNORE INTO admin_users (id, email, password) VALUES (1, 'admin@nuxt.com', 'admin');
```
::

::tip
All migrations queries are copied to `.data/db/queries` when you run Nuxt, giving you a consolidated view.
::

## Foreign-key constraints

For Cloudflare D1 with Drizzle ORM migrations, replace:

```diff [Example]
-PRAGMA foreign_keys = OFF;
+PRAGMA defer_foreign_keys = on;

ALTER TABLE ...

-PRAGMA foreign_keys = ON;
+PRAGMA defer_foreign_keys = off;
```

::callout{to="https://developers.cloudflare.com/d1/sql-api/foreign-keys/#defer-foreign-key-constraints" external}
Learn more about [defer foreign key constraints](https://developers.cloudflare.com/d1/sql-api/foreign-keys/#defer-foreign-key-constraints) in Cloudflare D1.
::
